<div class="stats-page">

  <div class="date-controls">
    <div class="mode-toggle" *ngIf="stats?.globalAvailable">
      <mat-slide-toggle [(ngModel)]="globalMode" (change)="onModeChange()">Alle Chöre</mat-slide-toggle>
    </div>

    <mat-form-field appearance="fill">
      <mat-label>Von</mat-label>
      <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" />
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Bis</mat-label>
      <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" />
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Aktive Monate</mat-label>
      <input matInput type="number" [(ngModel)]="activeMonths" />
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="loadStats()">Statistik laden</button>
  </div>

  <ng-container *ngIf="stats">
    <!-- Top Service Pieces -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Top 3 Gottesdienst-Stücke{{ globalMode ? ' (Alle Chöre)' : '' }}</mat-card-title>
        <button mat-icon-button (click)="toggleSection('topService')" [attr.aria-label]="collapsedSections['topService'] ? 'Ausklappen' : 'Einklappen'">
          <mat-icon>{{ collapsedSections['topService'] ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content *ngIf="!collapsedSections['topService']">
        <ol>
          <li *ngFor="let item of stats.topServicePieces">
            <a [routerLink]="['/pieces', item.id]" class="piece-item-link">{{ item.title }}</a> ({{ item.count }}x)
          </li>
        </ol>
      </mat-card-content>
    </mat-card>

    <!-- Top Rehearsal Pieces -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Meist geprobte Stücke{{ globalMode ? ' (Alle Chöre)' : '' }}</mat-card-title>
        <button mat-icon-button (click)="toggleSection('topRehearsal')" [attr.aria-label]="collapsedSections['topRehearsal'] ? 'Ausklappen' : 'Einklappen'">
          <mat-icon>{{ collapsedSections['topRehearsal'] ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content *ngIf="!collapsedSections['topRehearsal']">
        <ol>
          <li *ngFor="let item of stats.topRehearsalPieces">
            <a [routerLink]="['/pieces', item.id]" class="piece-item-link">{{ item.title }}</a> ({{ item.count }}x)
          </li>
        </ol>
      </mat-card-content>
    </mat-card>

    <!-- Least Used Pieces -->
    <mat-card *ngIf="leastUsedPieces.length">
      <mat-card-header>
        <mat-card-title>Lange nicht verwendet</mat-card-title>
        <button mat-icon-button (click)="toggleSection('leastUsed')" [attr.aria-label]="collapsedSections['leastUsed'] ? 'Ausklappen' : 'Einklappen'">
          <mat-icon>{{ collapsedSections['leastUsed'] ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content *ngIf="!collapsedSections['leastUsed']">
        <ol>
          <li *ngFor="let item of leastUsedPieces">
            <div class="least-used-row">
              <span class="least-used-info">
                <a [routerLink]="['/pieces', item.id]" class="piece-item-link">{{item.title}}</a>
                <span class="least-used-meta">({{item.count}} Monate)</span>
              </span>
              <button
                mat-stroked-button
                color="warn"
                (click)="resetRehearsalStatus(item)"
                [disabled]="globalMode || isLeastUsedUpdating(item.id)">
                <mat-icon>undo</mat-icon>
                Nicht im Repertoire setzen
              </button>
            </div>
          </li>
        </ol>
      </mat-card-content>
    </mat-card>

    <!-- Repertoire Statistics -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Stücke im Repertoire</mat-card-title>
        <button mat-icon-button (click)="toggleSection('repertoire')" [attr.aria-label]="collapsedSections['repertoire'] ? 'Ausklappen' : 'Einklappen'">
          <mat-icon>{{ collapsedSections['repertoire'] ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content *ngIf="!collapsedSections['repertoire']">
        <p>Singfähig: {{ stats.singableCount }}</p>
        <p>Probe: {{ stats.rehearsalCount }}</p>
      </mat-card-content>
    </mat-card>

    <!-- Rehearsal Table -->
    <mat-card class="table-card" *ngIf="!globalMode">
      <mat-card-header>
        <mat-card-title>Probe</mat-card-title>
        <button mat-icon-button (click)="toggleSection('rehearsal')" [attr.aria-label]="collapsedSections['rehearsal'] ? 'Ausklappen' : 'Einklappen'">
          <mat-icon>{{ collapsedSections['rehearsal'] ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content *ngIf="!collapsedSections['rehearsal']">
        <div class="table-wrapper mat-elevation-z4">
          <mat-table [dataSource]="rehearsalDataSource">
            <ng-container matColumnDef="title">
              <mat-header-cell *matHeaderCellDef> Titel </mat-header-cell>
              <mat-cell *matCellDef="let piece">
                <a [routerLink]="['/pieces', piece.id]" class="title-link">{{ piece.title }}</a>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="composer">
              <mat-header-cell *matHeaderCellDef> Komponist/Ursprung </mat-header-cell>
              <mat-cell *matCellDef="let piece">{{ piece.composer?.name || piece.origin }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="reference">
              <mat-header-cell *matHeaderCellDef> Sammlung </mat-header-cell>
              <mat-cell *matCellDef="let piece">{{ formatReference(piece) }}</mat-cell>
            </ng-container>
            <mat-header-row *matHeaderRowDef="displayedRehearsalColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: displayedRehearsalColumns;"></mat-row>
            <ng-container matNoDataRow>
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedRehearsalColumns.length">
                  Keine Stücke in Probe.
                </td>
              </tr>
            </ng-container>
          </mat-table>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-container>
</div>
