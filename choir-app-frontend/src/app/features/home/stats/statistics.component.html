<div class="stats-page">

  <div class="date-controls">
    <div class="mode-toggle" *ngIf="stats?.globalAvailable">
      <mat-slide-toggle [(ngModel)]="globalMode" (change)="onModeChange()">Alle Chöre</mat-slide-toggle>
    </div>

    <mat-form-field appearance="fill">
      <mat-label>Von</mat-label>
      <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" />
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Bis</mat-label>
      <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" />
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Aktive Monate</mat-label>
      <input matInput type="number" [(ngModel)]="activeMonths" />
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="loadStats()">Statistik laden</button>
  </div>

  <ng-container *ngIf="stats">
    <mat-card>
      <h3>Top 3 Gottesdienst-Stücke{{ globalMode ? ' (Alle Chöre)' : '' }}</h3>
      <ol>
        <li *ngFor="let item of stats.topServicePieces">
          <a [routerLink]="['/pieces', item.id]" class="piece-item-link">{{ item.title }}</a> ({{ item.count }}x)
        </li>
      </ol>
    </mat-card>

    <mat-card>
      <h3>Meist geprobte Stücke{{ globalMode ? ' (Alle Chöre)' : '' }}</h3>
      <ol>
        <li *ngFor="let item of stats.topRehearsalPieces">
          <a [routerLink]="['/pieces', item.id]" class="piece-item-link">{{ item.title }}</a> ({{ item.count }}x)
        </li>
      </ol>
    </mat-card>

    <mat-card *ngIf="leastUsedPieces.length">
      <h3>Lange nicht verwendet</h3>
      <ol>
        <li *ngFor="let item of leastUsedPieces">
          <a [routerLink]="['/pieces', item.id]" class="piece-item-link">{{item.title}}</a> ({{item.count}} Monate)
        </li>
      </ol>
    </mat-card>

    <mat-card>
      <h3>Stücke im Repertoire</h3>
      <p>Singfähig: {{ stats.singableCount }}</p>
      <p>Probe: {{ stats.rehearsalCount }}</p>
    </mat-card>

    <mat-card class="table-card" *ngIf="!globalMode">
      <mat-card-header>
        <mat-card-title>Probe</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-wrapper mat-elevation-z4">
          <mat-table [dataSource]="rehearsalDataSource">
            <ng-container matColumnDef="title">
              <mat-header-cell *matHeaderCellDef> Titel </mat-header-cell>
              <mat-cell *matCellDef="let piece">
                <a [routerLink]="['/pieces', piece.id]" class="title-link">{{ piece.title }}</a>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="composer">
              <mat-header-cell *matHeaderCellDef> Komponist/Ursprung </mat-header-cell>
              <mat-cell *matCellDef="let piece">{{ piece.composer?.name || piece.origin }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="reference">
              <mat-header-cell *matHeaderCellDef> Sammlung </mat-header-cell>
              <mat-cell *matCellDef="let piece">{{ formatReference(piece) }}</mat-cell>
            </ng-container>
            <mat-header-row *matHeaderRowDef="displayedRehearsalColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: displayedRehearsalColumns;"></mat-row>
            <ng-container matNoDataRow>
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedRehearsalColumns.length">
                  Keine Stücke in Probe.
                </td>
              </tr>
            </ng-container>
          </mat-table>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-container>
</div>
