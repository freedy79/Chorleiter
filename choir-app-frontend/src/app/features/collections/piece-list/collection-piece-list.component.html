<div class="header-actions">
  <mat-button-toggle-group [value]="viewMode" (change)="onViewChange($event.value)">
    <mat-button-toggle value="collections">Sammlungen</mat-button-toggle>
    <mat-button-toggle value="pieces">Stücke</mat-button-toggle>
  </mat-button-toggle-group>
</div>

<div class="letter-filter">
  <button mat-button *ngFor="let l of letters" (click)="onLetterSelect(l)" [color]="selectedLetter === l ? 'primary' : undefined">
    {{ l }}
  </button>
</div>

<ng-container *ngIf="!(isHandset$ | async); else mobileView">
<div class="table-wrapper mat-elevation-z8">
  <div class="table-scroll-container">
    <mat-table [dataSource]="dataSource" matSort matSortActive="title" matSortDirection="asc">
      <ng-container matColumnDef="title">
        <mat-header-cell *matHeaderCellDef mat-sort-header="title">Titel</mat-header-cell>
        <mat-cell *matCellDef="let piece" class="title-cell">
          <strong>{{ piece.title }}</strong>
          <div class="subtitle-hint" *ngIf="piece.subtitle">{{ piece.subtitle }}</div>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="composer">
        <mat-header-cell *matHeaderCellDef mat-sort-header="composer">Komponist/Ursprung</mat-header-cell>
        <mat-cell *matCellDef="let piece">{{ piece.composer?.name || piece.origin || '-' }}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="author">
        <mat-header-cell *matHeaderCellDef mat-sort-header="author">Dichter</mat-header-cell>
        <mat-cell *matCellDef="let piece">{{ piece.author?.name || '-' }}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="collections">
        <mat-header-cell *matHeaderCellDef mat-sort-header="collectionCount">Anzahl in Sammlungen</mat-header-cell>
        <mat-cell *matCellDef="let piece" class="count-cell">{{ piece.collectionCount || 0 }}</mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;" (click)="openPiece(row)"></mat-row>
      <ng-container matNoDataRow>
        <mat-row>
          <mat-cell [attr.colspan]="displayedColumns.length">Keine Stücke gefunden.</mat-cell>
        </mat-row>
      </ng-container>
    </mat-table>
  </div>
  <mat-paginator [length]="totalPieces" [pageSizeOptions]="pageSizeOptions" [pageSize]="pageSize" showFirstLastButtons></mat-paginator>
</div>
</ng-container>

<ng-template #mobileView>
  <div class="mobile-list">
    <div class="mobile-item" *ngFor="let piece of dataSource.data" (click)="toggleSelection(piece)">
      <div><strong>{{ piece.title }}</strong></div>
      <div class="subtitle-hint" *ngIf="piece.subtitle">{{ piece.subtitle }}</div>
      <div class="detail">Komponist/Ursprung: {{ piece.composer?.name || piece.origin || '-' }}</div>
      <div class="detail">Dichter: {{ piece.author?.name || '-' }}</div>
      <div class="detail">Anzahl in Sammlungen: {{ piece.collectionCount || 0 }}</div>
      <div class="mobile-actions" *ngIf="selectedPiece === piece">
        <button mat-icon-button (click)="openPiece(piece); $event.stopPropagation()" matTooltip="Details">
          <mat-icon>open_in_new</mat-icon>
        </button>
      </div>
    </div>
  </div>
</ng-template>
