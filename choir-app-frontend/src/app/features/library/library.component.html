<mat-tab-group>
  <mat-tab label="Nutzungshinweise">
    <section class="library-text">
      <p>ChorleiterInnen der NAK Nord- und Ostdeutschland können Originale der in der Inventarliste aufgeführten (Einzel-)Kompositionen ausleihen. Sammelbände/Bücher sind nur nach Absprache ausleihbar.</p>
      <p>Ausleihe und Zusendung der Noten sind für den Entleiher kostenlos.</p>
      <p>Der Zeitraum der Ausleihe beträgt 3 Monate und kann einmal verlängert werden. Der Entleiher verpflichtet sich zur vollständigen Rückgabe der entliehenen Exemplare bzw. sorgt bei Verlust für Ersatz.</p>
      <p>Die Nutzer dürfen im probenüblichen Umfang Notizen mit Bleistift in die Noten eintragen.</p>
      <p>Die Anfrage zur Ausleihe erfolgt per E-Mail an chorbibliothek&commat;nak-nordost.de und enthält mindestens folgende Angaben:</p>
      <ul>
        <li>Name des Entleihers</li>
        <li>Telefonnummer</li>
        <li>Gemeinde/Bezirk</li>
        <li>gewünschte/r Titel</li>
        <li>Anzahl benötigter Exemplare</li>
        <li>Lieferadresse</li>
        <li>Grund der Ausleihe (z.B. Konzert, Jugendfreizeit)</li>
      </ul>
      <p>Hinweis: Dadurch, dass eine Komposition in unserer Notenbibliothek ausleihbar ist, ist keine Ableitung zur "automatischen Eignung" für spezielle Anlässe (Gottesdienst, Konzert, Freizeiten…) möglich. Die Verwendung dieser Literatur erfolgt genauso wie bei allen anderen Notenmaterialien, die nicht von der NAK herausgegeben wurden.</p>
    </section>
  </mat-tab>

  <mat-tab label="Bibliotheksliste">
    <div class="list-header" *ngIf="isAdmin || isLibrarian">
      <input type="file" #fileInput (change)="onFileSelected($event)" hidden />
      <button mat-icon-button [matMenuTriggerFor]="adminMenu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #adminMenu="matMenu">
        <button mat-menu-item (click)="fileInput.click()">CSV importieren</button>
        <button mat-menu-item (click)="openAddDialog()">Stück hinzufügen</button>
      </mat-menu>
    </div>

    <mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8" multiTemplateDataRows>
      <ng-container matColumnDef="cover">
        <mat-header-cell *matHeaderCellDef></mat-header-cell>
        <mat-cell *matCellDef="let element" class="cover-cell">
          <img *ngIf="element.collection?.coverImageData" [src]="element.collection.coverImageData" alt="Cover" loading="lazy" />
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="title">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Titel</mat-header-cell>
        <mat-cell *matCellDef="let element">
          <div class="composer-hint" *ngIf="getCollectionComposer(element.collection) as composer">{{ composer }}</div>
          <div class="title">{{ element.collection?.title }}</div>
          <div class="subtitle-hint" *ngIf="getCollectionHint(element.collection) as hint">{{ hint }}</div>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="copies">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Exemplare</mat-header-cell>
        <mat-cell *matCellDef="let element">{{element.copies}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef></mat-header-cell>
        <mat-cell *matCellDef="let element">
          <button mat-icon-button color="primary" *ngIf="element.status === 'available' && !isSingerOnly" (click)="addToCart(element, $event)">
            <mat-icon>add_shopping_cart</mat-icon>
          </button>
          <button mat-icon-button *ngIf="isAdmin || isLibrarian" [matMenuTriggerFor]="itemMenu" (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #itemMenu="matMenu">
            <button mat-menu-item (click)="editCopies(element, $event)">Bestand ändern</button>
            <button mat-menu-item (click)="changeStatus(element, $event)">Entleihstatus ändern</button>
            <button mat-menu-item class="delete-button" (click)="deleteItem(element, $event)">Löschen</button>
          </mat-menu>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="expandedDetail">
        <mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div *ngIf="expandedItem === element">
            <mat-nav-list>
              <a mat-list-item *ngFor="let piece of paginatedPieces" [routerLink]="['/pieces', piece.id]" (click)="$event.stopPropagation()">
                {{ piece.title }}
                <span *ngIf="piece.composer?.name || piece.origin">
                  – {{ piece.composer?.name || piece.origin }}
                </span>
                <span *ngIf="piece.opus"> ({{ piece.opus }})</span>
              </a>
            </mat-nav-list>
            <mat-paginator [length]="expandedPieces.length" [pageSize]="piecePageSize" (page)="onPiecePage($event)"></mat-paginator>
          </div>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;" (click)="toggleCollection(row)" class="clickable-row"></mat-row>
      <mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></mat-row>
    </mat-table>
    <mat-paginator #libraryPaginator [pageSize]="10" [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
  </mat-tab>

  <mat-tab *ngIf="isAdmin || isLibrarian" label="Ausleihen">
    <app-loan-list></app-loan-list>
  </mat-tab>
</mat-tab-group>
