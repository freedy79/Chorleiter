<h1 mat-dialog-title>{{ isEdit ? 'Beitrag bearbeiten' : 'Neuer Beitrag' }}</h1>
<div mat-dialog-content>
  <form [formGroup]="form">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Titel</mat-label>
      <input matInput formControlName="title">
    </mat-form-field>
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Text</mat-label>
      <textarea matInput rows="5" formControlName="text" placeholder="Markdown möglich" (keydown)="onTextKeyDown($event)"></textarea>
    </mat-form-field>
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Markdown-Hilfe</mat-panel-title>
      </mat-expansion-panel-header>
      <p><code># Überschrift</code> → <strong>Überschrift</strong></p>
      <p><code>**fett**</code> → <strong>fett</strong></p>
      <p><code>*kursiv*</code> → <em>kursiv</em></p>
      <p><code>`Code`</code> → <code>Code</code></p>
      <p><code>[Link](https://beispiel.de)</code></p>
      <p><code>- Liste</code></p>
    </mat-expansion-panel>
    <h3>Vorschau</h3>
    <div class="preview" [innerHTML]="form.get('text')?.value | markdown | async"></div>
    <mat-divider></mat-divider>
    <div class="poll-section">
      <div class="poll-header">
        <h3>Abstimmung</h3>
        <mat-slide-toggle formControlName="enablePoll">Abstimmung hinzufügen</mat-slide-toggle>
      </div>
      <ng-container *ngIf="form.get('enablePoll')?.value">
        <p class="hint">Lege die Optionen an, sortiere sie und definiere, ob Mehrfachauswahl erlaubt ist.</p>
        <mat-checkbox formControlName="pollAllowMultiple" (change)="toggleAllowMultiple($event.checked)">
          Mehrfachauswahl erlauben
        </mat-checkbox>
        <mat-form-field appearance="fill" class="full-width" *ngIf="form.get('pollAllowMultiple')?.value">
          <mat-label>Maximale Stimmen pro Person</mat-label>
          <input matInput type="number" min="1" [max]="pollOptions.length" formControlName="pollMaxSelections">
        </mat-form-field>
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Ablaufdatum der Abstimmung</mat-label>
          <input matInput [matDatepicker]="pollPicker" formControlName="pollClosesAt">
          <mat-datepicker-toggle matSuffix [for]="pollPicker"></mat-datepicker-toggle>
          <mat-datepicker #pollPicker></mat-datepicker>
        </mat-form-field>
        <div cdkDropList (cdkDropListDropped)="dropPollOption($event)" class="poll-options">
          <div class="poll-option" *ngFor="let ctrl of pollOptions.controls; let i = index" cdkDrag>
            <mat-icon cdkDragHandle>drag_handle</mat-icon>
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Option {{ i + 1 }}</mat-label>
              <input matInput [formControl]="ctrl">
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="removePollOption(i)" [disabled]="pollOptions.length <= 2" matTooltip="Option entfernen">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        <button mat-button color="primary" type="button" (click)="addPollOption()">
          <mat-icon>add</mat-icon>
          Option hinzufügen
        </button>
      </ng-container>
    </div>
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Ablaufdatum</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="expiresAt">
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>
    <div class="attachment-section">
      <h3>Anhang</h3>
      <div *ngIf="existingAttachment && !selectedFile" class="existing-attachment">
        <mat-icon>attach_file</mat-icon>
        <span>{{ existingAttachment }}</span>
        <button mat-icon-button color="warn" (click)="markRemoveAttachment()" matTooltip="Anhang entfernen">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div *ngIf="selectedFile" class="selected-file">
        <mat-icon>attach_file</mat-icon>
        <span>{{ selectedFile.name }}</span>
        <button mat-icon-button color="warn" (click)="clearSelectedFile()" matTooltip="Auswahl aufheben">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <button mat-stroked-button type="button" (click)="fileInput.click()" *ngIf="!selectedFile && !existingAttachment">
        <mat-icon>upload_file</mat-icon>
        Datei auswählen
      </button>
      <input #fileInput type="file" hidden (change)="onFileSelected($event)"
             accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.mp3,.zip">
    </div>
    <mat-checkbox formControlName="sendTest">Test-E-Mail an mich senden</mat-checkbox>
    <mat-checkbox formControlName="sendAsUser">Eigene Adresse als Absender verwenden</mat-checkbox>
  </form>
</div>
<div mat-dialog-actions>
  <button mat-button (click)="cancel()" [disabled]="saving">Abbrechen</button>
  <button mat-flat-button color="primary" (click)="save()" [disabled]="form.invalid || saving">
    <ng-container *ngIf="!saving; else savingLabel">Speichern</ng-container>
  </button>
  <ng-template #savingLabel>Speichern…</ng-template>
</div>
