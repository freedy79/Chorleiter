<div class="profile-container">


  <div *ngIf="isLoading; else profileContent" class="loading-state">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Lade Benutzerprofil...</p>
  </div>

  <ng-template #profileContent>
    <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-form">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Persönliche Daten</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="name-row">
            <mat-form-field appearance="outline">
              <mat-label>Vorname</mat-label>
              <input matInput formControlName="firstName">
              <mat-error *ngIf="profileForm.get('firstName')?.hasError('required')">Vorname ist erforderlich.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nachname</mat-label>
              <input matInput formControlName="name">
              <mat-error *ngIf="profileForm.get('name')?.hasError('required')">Nachname ist erforderlich.</mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>E-Mail-Adresse</mat-label>
            <input matInput formControlName="email" type="email">
            <mat-error *ngIf="profileForm.get('email')?.hasError('required')">E-Mail ist erforderlich.</mat-error>
            <mat-error *ngIf="profileForm.get('email')?.hasError('email')">Bitte eine gültige E-Mail-Adresse eingeben.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Telefonnummer</mat-label>
            <input matInput formControlName="phone" type="tel">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Straße</mat-label>
            <input matInput formControlName="street">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Postleitzahl</mat-label>
            <input matInput formControlName="postalCode">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ort</mat-label>
            <input matInput formControlName="city">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Bezirk</mat-label>
            <input type="text" matInput formControlName="district" [matAutocomplete]="districtAuto">
            <mat-autocomplete #districtAuto="matAutocomplete">
              <mat-option *ngFor="let d of districts" [value]="d.name">{{ d.name }}</mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Gemeinde</mat-label>
            <mat-select formControlName="congregation">
              <mat-option value="">-</mat-option>
              <mat-option *ngFor="let c of congregations" [value]="c.name">{{ c.name }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Stimmlage</mat-label>
            <mat-select formControlName="voice">
              <mat-option value="">-</mat-option>
              <mat-option value="Sopran I">Sopran I</mat-option>
              <mat-option value="Sopran II">Sopran II</mat-option>
              <mat-option value="Alt I">Alt I</mat-option>
              <mat-option value="Alt II">Alt II</mat-option>
              <mat-option value="Tenor I">Tenor I</mat-option>
              <mat-option value="Tenor II">Tenor II</mat-option>
              <mat-option value="Bass I">Bass I</mat-option>
              <mat-option value="Bass II">Bass II</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-checkbox formControlName="shareWithChoir">Erlaube Nutzung meiner Daten für Chorleiter</mat-checkbox>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Systemrolle</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <ng-container *ngIf="profileForm.get('roles')?.enabled; else readonlyRoles">
            <mat-form-field appearance="outline">
              <mat-label>Systemrollen</mat-label>
              <mat-select formControlName="roles" multiple>
                <mat-option value="user" disabled>Standardnutzer</mat-option>
                <mat-option value="admin" disabled>Administrator</mat-option>
                <mat-option value="librarian">Bibliothekar</mat-option>
                <mat-option value="demo">Demo</mat-option>
              </mat-select>
            </mat-form-field>
          </ng-container>
          <ng-template #readonlyRoles>
            <div class="roles-display">{{ profileForm.get('roles')?.value?.join(', ') }}</div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card formGroupName="passwords">
        <mat-card-header>
          <mat-card-title>Passwort ändern</mat-card-title>
          <mat-card-subtitle>Lassen Sie alle Felder leer, um das bestehende Passwort zu erhalten.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline">
            <mat-label>Aktuelles Passwort</mat-label>
            <input matInput formControlName="oldPassword" type="password" autocomplete="current-password">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Neue Passwort</mat-label>
            <input matInput formControlName="newPassword" type="password" autocomplete="new-password">
            <mat-error *ngIf="profileForm.get('passwords.newPassword')?.hasError('weakPassword')">
              Passwort muss alle Anforderungen erfüllen
            </mat-error>
          </mat-form-field>

          <!-- Passwort-Anforderungen Anzeige (Option 1: Sanfte Migration) -->
          <div class="password-requirements" *ngIf="profileForm.get('passwords.newPassword')?.value">
            <div class="requirement" [class.met]="profileForm.get('passwords.newPassword')?.value?.length >= 12">
              <span class="icon">✓</span> Mindestens 12 Zeichen
            </div>
            <div class="requirement" [class.met]="hasUpperCase(profileForm.get('passwords.newPassword')?.value)">
              <span class="icon">✓</span> Ein Großbuchstabe (A-Z)
            </div>
            <div class="requirement" [class.met]="hasLowerCase(profileForm.get('passwords.newPassword')?.value)">
              <span class="icon">✓</span> Ein Kleinbuchstabe (a-z)
            </div>
            <div class="requirement" [class.met]="hasNumber(profileForm.get('passwords.newPassword')?.value)">
              <span class="icon">✓</span> Eine Zahl (0-9)
            </div>
            <div class="requirement" [class.met]="hasSpecialChar(profileForm.get('passwords.newPassword')?.value)">
              <span class="icon">✓</span> Ein Sonderzeichen (@$!%*?&)
            </div>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Neues Passwort bestätigen</mat-label>
            <input matInput formControlName="confirmPassword" type="password" autocomplete="new-password">
            <!-- Fehlermeldung, wenn Passwörter nicht übereinstimmen -->
            <mat-error *ngIf="profileForm.get('passwords')?.hasError('passwordsMismatch')">
              Die neuen Passwörter stimmen nicht überein.
            </mat-error>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Push-Benachrichtigungen</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="push-status">
            <mat-icon>notifications</mat-icon>
            <div>
              <div class="status-line">
                Status:
                <strong>
                  <ng-container *ngIf="!pushSupported">Nicht unterstützt</ng-container>
                  <ng-container *ngIf="pushSupported && pushPermission === 'granted'">Aktiviert</ng-container>
                  <ng-container *ngIf="pushSupported && pushPermission === 'default'">Ausstehend</ng-container>
                  <ng-container *ngIf="pushSupported && pushPermission === 'denied'">Blockiert</ng-container>
                </strong>
              </div>
              <div class="hint" *ngIf="pushPermission === 'denied'">
                Bitte erlaube Benachrichtigungen in deinem Browser, um Push-Nachrichten zu erhalten.
              </div>
            </div>
          </div>

          <div class="push-actions">
            <mat-slide-toggle
              [checked]="pushPermission === 'granted'"
              [disabled]="!pushSupported || isPushUpdating"
              (change)="onTogglePushMaster($event.checked)"
            >
              Push-Benachrichtigungen aktivieren
            </mat-slide-toggle>

            <button
              mat-stroked-button
              type="button"
              (click)="onRequestPushPermission()"
              *ngIf="pushSupported && pushPermission !== 'granted'"
            >
              Berechtigung anfragen
            </button>
          </div>

          <div class="choir-push-list" *ngIf="pushSupported; else pushUnsupported">
            <div *ngIf="choirList.length === 0" class="choir-empty">
              Keine Chöre für Push-Benachrichtigungen verfügbar.
            </div>
            <div class="choir-entry" *ngFor="let choir of choirList">
              <div class="choir-name">{{ choir.name }}</div>
              <mat-slide-toggle
                [checked]="pushStates[choir.id]"
                [disabled]="pushPermission !== 'granted' || isPushUpdating"
                (change)="onToggleChoirPush(choir.id, $event.checked)"
              >
                Benachrichtigen
              </mat-slide-toggle>
            </div>
          </div>
          <ng-template #pushUnsupported>
            <div class="choir-empty">
              Push-Benachrichtigungen werden in diesem Browser oder Modus nicht unterstützt.
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card *ngIf="(availableChoirs$ | async) as choirs">
        <mat-card-header>
          <mat-card-title>Verknüpfte Chöre</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="choirs.length === 0" class="choir-empty">
            Du bist derzeit mit keinem Chor verknüpft.
          </div>
          <div class="choir-entry" *ngFor="let choir of choirs">
            <div class="choir-name">{{ choir.name }}</div>
            <button
              mat-stroked-button
              color="warn"
              type="button"
              (click)="onLeaveChoir(choir)"
              [disabled]="isDemo$ | async"
            >
              Aus Chor abmelden
            </button>
          </div>
          <div class="choir-hint" *ngIf="choirs.length === 1">
            Das Verlassen dieses Chors löscht dein Profil vollständig.
          </div>
        </mat-card-content>
        <mat-card-actions *ngIf="choirs.length > 1">
          <button
            mat-flat-button
            color="warn"
            type="button"
            (click)="onDeleteAccount()"
            [disabled]="isDemo$ | async"
          >
            Vom gesamten System abmelden
          </button>
        </mat-card-actions>
      </mat-card>

      <div class="actions-footer" *ngIf="!(isDemo$ | async)">
        <button mat-flat-button color="primary" type="submit" [disabled]="profileForm.invalid || profileForm.pristine">
          Speichern
        </button>
      </div>
    </form>
  </ng-template>
</div>
