<div class="manual-inputs">
  <mat-form-field appearance="fill">
    <mat-label>Monat</mat-label>
    <input matInput type="number" [(ngModel)]="selectedMonth" min="1" max="12" (change)="monthChanged()" />
  </mat-form-field>
  <mat-form-field appearance="fill">
    <mat-label>Jahr</mat-label>
    <input matInput type="number" [(ngModel)]="selectedYear" (change)="monthChanged()" />
  </mat-form-field>
</div>

<div class="month-nav">
  <button mat-button color="primary" (click)="previousMonth()">
    <mat-icon>chevron_left</mat-icon>
    {{ prevMonthLabel }}
  </button>
  <button mat-button color="primary" (click)="nextMonth()">
    {{ nextMonthLabel }}
    <mat-icon>chevron_right</mat-icon>
  </button>
</div>

<ng-container *ngIf="isDeveloper">
<div class="plan-controls">
  <button mat-stroked-button color="primary" (click)="reloadPlan()" [disabled]="isLoadingPlan">
    <mat-icon>refresh</mat-icon>
    Neu laden
  </button>
</div>

<div class="load-metrics" *ngIf="loadDurationSeconds as total">
  <h3>Ladezeiten</h3>
  <p class="load-total">
    Gesamtzeit: <span class="load-time">{{ total }}</span> s
    <span *ngIf="loadMetrics?.error" class="load-error">(Fehler beim Laden)</span>
  </p>
  <table *ngIf="loadStepDetails.length > 0">
    <thead>
      <tr>
        <th>Schritt</th>
        <th>Seit Start (s)</th>
        <th>Seit vorher (s)</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let step of loadStepDetails">
        <td>{{ step.label }}</td>
        <td>{{ step.sinceStart }}</td>
        <td>{{ step.delta }}</td>
      </tr>
    </tbody>
  </table>
</div>
</ng-container>

<mat-tab-group [selectedIndex]="selectedTab" (selectedIndexChange)="tabChanged($event)">

  <mat-tab label="Dienstplan">
    <div class="plan" *ngIf="plan && !isLoadingPlan; else planFallback">
      <h2>Dienstplan {{ plan.month }}/{{ plan.year }}</h2>
      <div class="actions">
        <button *ngIf="isChoirAdmin && !plan.finalized" mat-raised-button color="primary" (click)="openAddEntryDialog()"
          matTooltip="Eintrag hinzufügen"><mat-icon>add</mat-icon></button>
        <button *ngIf="isChoirAdmin && !plan.finalized" mat-raised-button color="primary" (click)="finalizePlan()"
          matTooltip="Plan finalisieren"><mat-icon>lock</mat-icon></button>
        <button *ngIf="isChoirAdmin && plan.finalized" mat-raised-button color="primary" (click)="reopenPlan()"
          matTooltip="Plan erneut öffnen"><mat-icon>lock_open</mat-icon></button>
        <button *ngIf="plan.finalized" mat-raised-button color="accent" (click)="downloadPdf()"
          matTooltip="Als PDF herunterladen"><mat-icon>picture_as_pdf"</mat-icon></button>
        <button *ngIf="plan.finalized" mat-raised-button color="accent" (click)="openEmailDialog()"
          matTooltip="Als E-Mail versenden"><mat-icon>mail</mat-icon></button>
        <button *ngIf="isChoirAdmin && !plan.finalized" mat-raised-button color="accent"
          (click)="openAvailabilityDialog()" matTooltip="Verfügbarkeit anfragen"><mat-icon>Drafts</mat-icon></button>
      </div>
      <mat-table [dataSource]="entries" class="mat-elevation-z2">
        <ng-container matColumnDef="date">
          <mat-header-cell *matHeaderCellDef>Datum</mat-header-cell>
          <mat-cell *matCellDef="let ev" [matTooltip]="timestamp(ev.date)">
            {{ ev.date | pureDate | date:'shortDate':'Europe/Berlin':'de-DE' }}
            <span class="holiday" *ngIf="ev.holidayHint"> ({{ ev.holidayHint }})</span>
          </mat-cell>
        </ng-container>
        <ng-container matColumnDef="director">
          <mat-header-cell *matHeaderCellDef>Chorleiter</mat-header-cell>
          <mat-cell *matCellDef="let ev">
            <ng-container *ngIf="isChoirAdmin && !plan.finalized; else directorText">
              <mat-select [value]="ev.director?.id || null" (selectionChange)="updateDirector(ev, $event.value)">
                <mat-option [value]="null">--</mat-option>
                <mat-option *ngFor="let m of availableForDate(directors, ev.date)" [value]="m.id">
                  <span class="person-option" [class.person-option--maybe]="isMaybe(m.id, ev.date)">
                    <mat-icon *ngIf="isMaybe(m.id, ev.date)" class="person-option__icon" color="warn">warning</mat-icon>
                    {{ m.name }}, {{ m.firstName }}
                  </span>
                </mat-option>
              </mat-select>
              <mat-icon *ngIf="ev.director?.id && isMaybe(ev.director.id, ev.date)" class="warning-icon" color="warn"
                matTooltip="Nur nach Absprache verfügbar">warning</mat-icon>
            </ng-container>
            <ng-template #directorText>
              {{ ev.director?.name }}, {{ ev.director?.firstName }}
              <mat-icon *ngIf="ev.director?.id && isMaybe(ev.director.id, ev.date)" class="warning-icon" color="warn"
                matTooltip="Nur nach Absprache verfügbar">warning</mat-icon>
            </ng-template>
          </mat-cell>
        </ng-container>
        <ng-container matColumnDef="organist">
          <mat-header-cell *matHeaderCellDef>Organist</mat-header-cell>
          <mat-cell *matCellDef="let ev">
            <ng-container *ngIf="isChoirAdmin && !plan.finalized; else organistText">
              <mat-select [value]="ev.organist?.id || null" (selectionChange)="updateOrganist(ev, $event.value)">
                <mat-option [value]="null">--</mat-option>
                <mat-option *ngFor="let m of availableForDate(organists, ev.date)" [value]="m.id">
                  <span class="person-option" [class.person-option--maybe]="isMaybe(m.id, ev.date)">
                    <mat-icon *ngIf="isMaybe(m.id, ev.date)" class="person-option__icon" color="warn">warning</mat-icon>
                    {{ m.name }}, {{ m.firstName }}
                  </span>
                </mat-option>
              </mat-select>
              <mat-icon *ngIf="ev.organist?.id && isMaybe(ev.organist.id, ev.date)" class="warning-icon" color="warn"
                matTooltip="Nur nach Absprache verfügbar">warning</mat-icon>
            </ng-container>
            <ng-template #organistText>
              {{ ev.organist?.name }}, {{ ev.organist?.firstName }}
              <mat-icon *ngIf="ev.organist?.id && isMaybe(ev.organist.id, ev.date)" class="warning-icon" color="warn"
                matTooltip="Nur nach Absprache verfügbar">warning</mat-icon>
            </ng-template>
          </mat-cell>
        </ng-container>
        <ng-container matColumnDef="notes">
          <mat-header-cell *matHeaderCellDef>Notizen</mat-header-cell>
          <mat-cell *matCellDef="let ev">
            <ng-container *ngIf="isChoirAdmin && !plan.finalized; else notesText">
              <input matInput [(ngModel)]="ev.notes" (blur)="updateNotes(ev, ev.notes)" />
            </ng-container>
            <ng-template #notesText>{{ ev.notes }}</ng-template>
          </mat-cell>
        </ng-container>
        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef></mat-header-cell>
          <mat-cell *matCellDef="let ev">
            <button mat-icon-button color="warn" *ngIf="isChoirAdmin && !plan.finalized" (click)="deleteEntry(ev)">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"
          [class.assigned]="plan.finalized && (row.director?.id === currentUserId || row.organist?.id === currentUserId)"></mat-row>
      </mat-table>

      <div class="spacer"></div>

      <div class="counter-plan" *ngIf="counterPlanDates.length > 0">
        <h3>Gegenplan</h3>
        <div class="counter-plan-table">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th *ngFor="let d of counterPlanDates" [matTooltip]="timestamp(d)">{{ d |
                  date:'dd.MM.':'Europe/Berlin':'de-DE' }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of counterPlanRows">
                <td>{{ row.user.name }}, {{ row.user.firstName }}</td>
                <td *ngFor="let key of counterPlanDateKeys">{{ row.assignments[key] }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </mat-tab>
  <mat-tab label="Verfügbarkeiten">
    <div>
      <h3>Meine Verfügbarkeiten</h3>
      <app-availability-table [year]="selectedYear" [month]="selectedMonth"></app-availability-table>
      <div *ngIf="isChoirAdmin" class="member-availabilities">
        <h3>Verfügbarkeiten aller Mitglieder</h3>
        <div *ngFor="let ev of entries">
          <h4>{{ ev.date | pureDate | date:'EEE dd.MM.yyyy':'Europe/Berlin':'de-DE' }}</h4>
          <p><strong>verfügbar:</strong> {{ memberNamesByAvailability(ev.date, 'AVAILABLE') }}</p>
          <p><strong>nach Absprache:</strong> {{ memberNamesByAvailability(ev.date, 'MAYBE') }}</p>
          <p><strong>nicht verfügbar:</strong> {{ memberNamesByAvailability(ev.date, 'UNAVAILABLE') }}</p>
        </div>
      </div>
    </div>
  </mat-tab>
</mat-tab-group>
<ng-template #planFallback>
  <ng-container *ngIf="isLoadingPlan; else noPlan">
    <div class="loading">
      <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
    </div>
  </ng-container>
</ng-template>
<ng-template #noPlan>
  <p>Kein Dienstplan für diesen Monat vorhanden.</p>
  <button *ngIf="isChoirAdmin" mat-raised-button color="primary" (click)="createPlan()">Plan erstellen</button>
</ng-template>
