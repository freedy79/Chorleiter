<mat-toolbar color="primary" class="main-toolbar">

  <ng-container *ngIf="(isLoggedIn$ | async)">
    <button type="button" aria-label="Menü umschalten" class="sidenav-toggle" mat-icon-button (click)="toggleDrawer()">
      <mat-icon aria-label="Side nav toggle icon">menu</mat-icon>
    </button>
  </ng-container>

  <span class="title"><a href="/" class="page-title-link">NAK Chorleiter</a></span>

  <!-- Search bar -->
  <ng-container *ngIf="isLoggedIn$ | async">
    <!-- Desktop Search - Always visible -->
    <ng-container *ngIf="!(isSmallScreen$ | async)">
      <app-search-box class="search"></app-search-box>
    </ng-container>
  </ng-container>

  <button mat-raised-button color="accent" class="choir-badge" [matMenuTriggerFor]="choirMenu" [disabled]="isDemo$ | async"
    *ngIf="(availableChoirs$ | async)?.length && ((isSmallScreen$ | async) !== true)">
    {{ (activeChoir$ | async)?.name || 'Chor wählen' }}
  </button>

  <!-- Mobile: Choir Switcher als Bottom Sheet -->
  <button mat-icon-button class="choir-badge-mobile" (click)="openChoirSwitcher()" [disabled]="isDemo$ | async"
    *ngIf="(availableChoirs$ | async)?.length && (isSmallScreen$ | async)"
    matTooltip="{{ (activeChoir$ | async)?.name || 'Chor wählen' }}">
    <mat-icon>groups</mat-icon>
  </button>

  <mat-menu #choirMenu="matMenu">
    <button mat-menu-item *ngFor="let c of (availableChoirs$ | async)" (click)="switchChoir(c.id)">{{ c.name }}</button>
  </mat-menu>

  <ng-container *ngIf="(isLoggedIn$ | async) && (isAdmin$ | async) === false && (donatedRecently$ | async) === false">
    <button mat-button color="accent" routerLink="/donate" class="donate-button">Spenden</button>
  </ng-container>

  <ng-container *ngIf="isLoggedIn$ | async">
    <button *ngIf="((cartCount$ | async) ?? 0) > 0" mat-icon-button routerLink="/library/request"
      [matBadge]="(cartCount$ | async) ?? 0" matBadgeColor="accent" matTooltip="Entleihkorb">
      <mat-icon>shopping_cart</mat-icon>
    </button>

    <span class="user-name" [ngClass]="{'hide-on-handset': (isHandset$ | async)}" [matTooltip]="userRole$ | async">{{ userName$ | async }}</span>

    <button mat-icon-button [matMenuTriggerFor]="userMenu" matTooltip="Benutzerprofil">
      <mat-icon>person</mat-icon>
    </button>

    <mat-menu #userMenu="matMenu">
      <a mat-menu-item routerLink="/profile">
        <mat-icon>person</mat-icon>
        <span>Profil</span>
      </a>

      <button mat-menu-item [matMenuTriggerFor]="choirMenu" *ngIf="((availableChoirs$ | async)?.length ?? 0) > 1 && !(isDemo$ | async)">
        <mat-icon>groups</mat-icon>
        <span>Chor wechseln</span>
      </button>

      <button mat-menu-item [matMenuTriggerFor]="themeMenu">
        <mat-icon>contrast</mat-icon>
        <span>Theme</span>
      </button>

      <button *ngIf="isAdmin$ | async" mat-menu-item (click)="openBuildInfo()">
        <mat-icon>info</mat-icon>
        <span>Build Info</span>
      </button>

      <button mat-menu-item (click)="openHelp()">
        <mat-icon>help_outline</mat-icon>
        <span>Hilfe</span>
      </button>

      <button mat-menu-item (click)="logout()">
        <mat-icon>logout</mat-icon>
        <span>Abmelden</span>
      </button>
    </mat-menu>

    <mat-menu #choirMenu="matMenu">
      <button mat-menu-item *ngFor="let c of (availableChoirs$ | async)" (click)="switchChoir(c.id)">{{ c.name }}</button>
    </mat-menu>

    <mat-menu #themeMenu="matMenu">
      <button mat-menu-item (click)="setTheme('light')">
        <mat-icon *ngIf="currentTheme === 'light'">check</mat-icon>
        <span>Light</span>
      </button>

      <button mat-menu-item (click)="setTheme('dark')">
        <mat-icon *ngIf="currentTheme === 'dark'">check</mat-icon>
        <span>Dark</span>
      </button>
      <button mat-menu-item (click)="setTheme('system')">
        <mat-icon *ngIf="currentTheme === 'system'">check</mat-icon>
        <span>System</span>
      </button>
    </mat-menu>
  </ng-container>

</mat-toolbar>

<mat-sidenav-container class="site-container" *ngIf="(isLoggedIn$ | async)">
  <mat-sidenav #appDrawer [fixedInViewport]="false" [attr.role]="(isHandset$ | async) ? 'dialog' : 'navigation'"
    [mode]="(isHandset$ | async) ? 'over' : 'side'" class="appDrawer" (backdropClick)="closeSidenav()">

    <ng-container *ngIf="(isLoggedIn$ | async)">
      <mat-nav-list>
        <app-menu-list-item *ngFor="let item of navItems" [item]="item"></app-menu-list-item>
      </mat-nav-list>
    </ng-container>
  </mat-sidenav>


  <mat-sidenav-content class="main-content">

    <app-error-display></app-error-display>
    <app-loading-indicator></app-loading-indicator>

    <div class="content-wrapper">
      <div class="container">
        <app-page-header *ngIf="pageTitle$ | async as pageTitle" [title]="pageTitle"></app-page-header>
        <router-outlet></router-outlet>
      </div>
    </div>


  </mat-sidenav-content>
 </mat-sidenav-container>

<main class="public-content" *ngIf="!(isLoggedIn$ | async)">
  <div class="container">
    <router-outlet></router-outlet>
  </div>
</main>

<!-- Bottom Navigation - Optimiert für Mobile -->
<nav class="bottom-nav" *ngIf="(isLoggedIn$ | async)">
  <a mat-button routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}"
    class="bottom-nav-item" matRipple [matRippleColor]="'rgba(0, 0, 0, 0.1)'">
    <mat-icon>home</mat-icon>
    <span class="nav-label">Home</span>
  </a>
  <a mat-button routerLink="/events" routerLinkActive="active"
    class="bottom-nav-item" matRipple [matRippleColor]="'rgba(0, 0, 0, 0.1)'">
    <mat-icon>event</mat-icon>
    <span class="nav-label">Termine</span>
  </a>
  <a mat-button routerLink="/repertoire" routerLinkActive="active"
    class="bottom-nav-item" matRipple [matRippleColor]="'rgba(0, 0, 0, 0.1)'">
    <mat-icon>library_music</mat-icon>
    <span class="nav-label">Repertoire</span>
  </a>
  <a mat-button routerLink="/library" routerLinkActive="active"
    class="bottom-nav-item" matRipple [matRippleColor]="'rgba(0, 0, 0, 0.1)'"
    *ngIf="(isAdmin$ | async) || (isLibrarian$ | async)">
    <mat-icon>local_library</mat-icon>
    <span class="nav-label">Bibliothek</span>
  </a>
  <a mat-button routerLink="/search" routerLinkActive="active"
    class="bottom-nav-item" matRipple [matRippleColor]="'rgba(0, 0, 0, 0.1)'">
    <mat-icon>search</mat-icon>
    <span class="nav-label">Suche</span>
  </a>
  <button mat-button class="bottom-nav-item bottom-nav-more" [matMenuTriggerFor]="moreMenu"
    matRipple [matRippleColor]="'rgba(0, 0, 0, 0.1)'"
    *ngIf="hasMoreItems$ | async">
    <mat-icon>more_horiz</mat-icon>
    <span class="nav-label">Mehr</span>
  </button>
</nav>

<!-- Overflow-Menü für zusätzliche Navigation Items -->
<mat-menu #moreMenu="matMenu" class="bottom-nav-overflow">
  <a mat-menu-item routerLink="/dienstplan" *ngIf="dienstplanVisible$ | async">
    <mat-icon>assignment</mat-icon>
    <span>Dienstplan</span>
  </a>
  <a mat-menu-item routerLink="/posts" *ngIf="(dienstplanVisible$ | async) === false">
    <mat-icon>article</mat-icon>
    <span>Beiträge</span>
  </a>
  <a mat-menu-item routerLink="/admin" *ngIf="(isAdmin$ | async) && !(isDemo$ | async)">
    <mat-icon>settings</mat-icon>
    <span>Admin</span>
  </a>
  <a mat-menu-item routerLink="/profile">
    <mat-icon>person</mat-icon>
    <span>Profil</span>
  </a>
</mat-menu>

<app-footer></app-footer>
